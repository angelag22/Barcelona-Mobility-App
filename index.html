<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCN Mobility PRO - Ultimate</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bicing-red: #e30613; 
            --bicing-blue: #00a1df; 
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a1a;
            --btn-sec: #f1f1f1;
            --accent-yellow: #ffcc00;
            --accent-green: #28a745;
            --accent-red: #dc3545;
        }

        body.dark-mode {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --text: #ffffff;
            --btn-sec: #2d2d2d;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 110px; color: var(--text); transition: background 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        .card { 
            background: var(--card); border-radius: 20px; padding: 18px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; 
        }

        /* NAVEGACI√ìN */
        nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .nav-link { padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: 700; background: var(--btn-sec); color: var(--text); border: none; }
        .nav-link.active { background: var(--bicing-red); color: white; }

        .btn-main {
            background: var(--bicing-red); color: white; border: none; width: 100%; padding: 15px;
            border-radius: 15px; font-size: 1rem; font-weight: 800; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }

        .dest-btn {
            background: var(--btn-sec); color: var(--text); border: none; padding: 15px;
            border-radius: 12px; font-weight: 700; display: flex; flex-direction: column; 
            align-items: center; gap: 5px; cursor: pointer; transition: 0.2s;
        }
        .dest-btn i { font-size: 1.5rem; }

        /* BUSCADOR Y FAVORITOS */
        .search-container { display: flex; gap: 8px; margin-top: 15px; }
        .search-container input { 
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; 
            background: var(--card); color: var(--text);
        }
        .btn-fav { 
            background: var(--accent-yellow); color: #000; border: none; padding: 12px; 
            border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
        .btn-fav.added { background: var(--accent-green); color: white; }
        
        .fav-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--btn-sec); padding: 10px; border-radius: 10px; margin-top: 8px;
        }
        .btn-delete { background: var(--accent-red); color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; }

        /* MAPA */
        #map-container { height: 0; overflow: hidden; transition: 0.4s ease-out; border-radius: 15px; margin-top: 10px; }
        #map-container.open { height: 250px; border: 1px solid #ddd; }
        #map { width: 100%; height: 100%; }

        /* SECCIONES */
        .section { display: none; }
        .section.active { display: block; }

        .theme-toggle { background: var(--card); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.1rem; }
    </style>
</head>
<body onclick="iniciarAudioInit()">

    <header>
        <h1 style="font-family:'Montserrat'; margin:0; font-size:1.2rem;">BCN Mobility <span style="color:var(--bicing-red)">PRO</span></h1>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
    </header>

    <nav>
        <div class="nav-link active" onclick="showTab('inicio', this)">Inicio</div>
        <div class="nav-link" onclick="showTab('sobremi', this)">Sobre M√≠</div>
    </nav>

    <div id="inicio" class="section active">
        <div class="card">
            <h2 style="margin:0 0 12px 0; font-size:1rem;">üö≤ Bicing Cercano</h2>
            <button id="btn-buscar" class="btn-main" onclick="buscarBicing()">üîç Buscar Estaciones</button>
            <div id="resultados-bicing" style="display:none;">
                <div id="lista-estaciones"></div>
                <button id="btn-map-toggle" class="btn-main" style="background:#444; margin-top:10px;" onclick="toggleMap()">üó∫Ô∏è Ver en Mapa</button>
                <div id="map-container"><div id="map"></div></div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 15px 0; font-size:1rem;">‚≠ê Rutas Favoritas</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" id="grid-favoritos">
                <button class="dest-btn" onclick="ir('Mercabarna', 'transit')"><i>üíº</i> Mercabarna</button>
                <button class="dest-btn" onclick="ir('Fira Barcelona Gran Via', 'transit')"><i>üè¢</i> Fira</button>
            </div>

            <div class="search-container">
                <input type="text" id="input-ruta" placeholder="Nombre de nueva ruta...">
                <button id="btn-add-fav" class="btn-fav" onclick="addFavorito()">A√±adir Favorita</button>
            </div>
            
            <div id="lista-favoritos-extra" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="sobremi" class="section">
        <div class="card">
            <h2 style="color:var(--bicing-red)">Acerca de BCN Mobility PRO</h2>
            <p><strong>BCN Mobility PRO</strong> es la herramienta definitiva para el ciudadano moderno en Barcelona.</p>
            <p>Esta aplicaci√≥n ha sido dise√±ada para optimizar tus trayectos diarios, permiti√©ndote consultar estaciones de <b>Bicing</b> en tiempo real con iconos personalizados y gestionar tus rutas de trabajo (<b>Mercabarna</b>) o eventos (<b>Fira</b>) con un solo toque.</p>
            <ul style="padding-left: 20px; line-height: 1.6;">
                <li>Mapa con iconos de bici roja profesionales.</li>
                <li>Modo Noche para ahorro de bater√≠a.</li>
                <li>Buscador de rutas personalizables.</li>
                <li>Persistencia de datos local.</li>
            </ul>
            <p style="font-size: 0.8rem; color: #888; margin-top: 20px;">Versi√≥n 2.0 - Powered by Urban Data BCN</p>
        </div>
    </div>

    <script>
        let map = null;
        let darkMode = false;
        let favoritos = JSON.parse(localStorage.getItem('fav_routes')) || [];

        // ICONO BICI ROJA (Corregido: Antes era una "moto amarilla" seg√∫n el usuario)
        const redBikeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', // Bici Roja
            iconSize: [35, 35], iconAnchor: [17, 35], popupAnchor: [0, -35]
        });

        function feedback(vibrate = 15) { if (navigator.vibrate) navigator.vibrate(vibrate); }

        function showTab(id, el) {
            feedback(10);
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            document.getElementById('theme-btn').innerHTML = darkMode ? '‚òÄÔ∏è' : 'üåô';
            if (map) {
                const layer = darkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
                L.tileLayer(layer).addTo(map);
            }
        }

        function toggleMap() {
            const container = document.getElementById('map-container');
            container.classList.toggle('open');
            setTimeout(() => { if(map) map.invalidateSize(); }, 400);
        }

        function ir(dest, modo) {
            feedback(30);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=${modo}`, '_blank');
        }

        // --- L√ìGICA DE FAVORITOS ---
        function addFavorito() {
            const input = document.getElementById('input-ruta');
            const btn = document.getElementById('btn-add-fav');
            if (input.value.trim() === "") return;

            const nuevaRuta = input.value.trim();
            favoritos.push(nuevaRuta);
            localStorage.setItem('fav_routes', JSON.stringify(favoritos));
            
            // Cambio de color din√°mico solicitado (Amarillo -> Verde)
            btn.classList.add('added');
            btn.innerHTML = "‚úì ¬°A√±adida!";
            feedback([20, 50, 20]);

            setTimeout(() => {
                btn.classList.remove('added');
                btn.innerHTML = "A√±adir Favorita";
                input.value = "";
                renderFavoritos();
            }, 1500);
        }

        function eliminarFavorito(index) {
            feedback(40);
            favoritos.splice(index, 1);
            localStorage.setItem('fav_routes', JSON.stringify(favoritos));
            renderFavoritos();
        }

        function renderFavoritos() {
            const container = document.getElementById('lista-favoritos-extra');
            container.innerHTML = favoritos.map((f, i) => `
                <div class="fav-item">
                    <span onclick="ir('${f}', 'transit')" style="font-weight:700; cursor:pointer;">üìç ${f}</span>
                    <button class="btn-delete" onclick="eliminarFavorito(${i})">Eliminar</button>
                </div>
            `).join('');
        }

        // --- BICING ---
        async function buscarBicing() {
            feedback(20);
            const btn = document.getElementById('btn-buscar');
            btn.innerHTML = "Buscando...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                const res = await fetch('https://api.citybik.es/v2/networks/bicing');
                const data = await res.json();
                
                const stations = data.network.stations
                    .map(s => ({ ...s, dist: Math.hypot(s.latitude-lat, s.longitude-lon) }))
                    .sort((a,b) => a.dist - b.dist).slice(0, 4);

                renderEstaciones(stations);
                initMap(lat, lon, stations);
                btn.innerHTML = "üîÑ Actualizar Bicing";
            });
        }

        function renderEstaciones(stations) {
            document.getElementById('resultados-bicing').style.display = 'block';
            document.getElementById('lista-estaciones').innerHTML = stations.map(s => `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <span><b>${s.name.replace(/^\d+\s*-\s*/, '')}</b></span>
                    <span>üö≤ ${s.free_bikes}</span>
                </div>
            `).join('');
        }

        function initMap(lat, lon, stations) {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            L.circleMarker([lat, lon], { color: 'blue', radius: 5 }).addTo(map);

            stations.forEach(s => {
                L.marker([s.latitude, s.longitude], { icon: redBikeIcon }) // ICONO BICI ROJA
                 .addTo(map)
                 .bindPopup(`${s.name}<br>Disponibles: ${s.free_bikes}`);
            });
        }

        // Carga inicial
        renderFavoritos();
    </script>
</body>
</html>
