<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCN Mobility PRO - √Ångel Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bicing-red: #e30613; 
            --bicing-blue: #00a1df; 
            --bg: #f8f9fa; --card: #ffffff; --text: #1a1a1a; --btn-sec: #f1f1f1;
        }
        body.dark-mode {
            --bg: #0f0f0f; --card: #1a1a1a; --text: #ffffff; --btn-sec: #2d2d2d;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 110px; color: var(--text); transition: 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); border-radius: 20px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }

        nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .nav-link { padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: 700; background: var(--btn-sec); color: var(--text); border: none; flex: 1; text-align: center; }
        .nav-link.active { background: var(--bicing-red); color: white; }

        .btn-main { background: var(--bicing-red); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }

        /* ESTACIONES */
        .station-card { background: var(--card); border: 1px solid rgba(128,128,128,0.1); border-radius: 16px; padding: 14px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 6px 12px; border-radius: 10px; font-size: 0.85rem; font-weight: 800; color: white; display: inline-flex; align-items: center; gap: 4px; }
        .badge-elec { background: var(--bicing-blue); }
        .badge-mech { background: var(--bicing-red); }

        /* FAVORITOS VERTICAL */
        .fav-list { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
        .fav-card { background: var(--card); border: 1px solid rgba(128,128,128,0.2); border-radius: 15px; padding: 15px; position: relative; }
        .fav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .transport-modes { display: flex; gap: 8px; }
        .mode-btn { background: var(--btn-sec); border: none; padding: 8px 12px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .mode-btn:hover { background: var(--bicing-red); color: white; }

        /* BUSCADOR */
        .search-box { position: relative; margin-top: 10px; }
        .search-box input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; background: var(--card); color: var(--text); }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }

        #map-container { height: 0; overflow: hidden; transition: 0.4s; border-radius: 15px; }
        #map-container.open { height: 280px; margin-top: 15px; border: 1px solid #ddd; }
        #map { width: 100%; height: 100%; }

        .section { display: none; }
        .section.active { display: block; }
        .theme-toggle { background: var(--card); border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .spotify-player { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; background: rgba(20,20,20,0.9); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between; z-index: 9999; color: white; }
    </style>
</head>
<body onclick="iniciarAudioInit()">

    <header>
        <h1 style="font-family:'Montserrat'; margin:0; font-size:1.3rem;">BCN Mobility <span style="color:var(--bicing-red)">PRO</span></h1>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
    </header>

    <nav>
        <button class="nav-link active" onclick="showTab('inicio', this)">Inicio</button>
        <button class="nav-link" onclick="showTab('sobremi', this)">Acerca de</button>
    </nav>

    <div id="inicio" class="section active">
        <div class="card">
            <h2 style="margin:0 0 15px 0; font-size:1.1rem; font-family:'Montserrat'">üö≤ Bicing Live</h2>
            <button id="btn-buscar" class="btn-main" onclick="buscarBicing()">üîç Buscar Estaciones</button>
            <div id="resultados-bicing" style="display:none;">
                <div id="lista-estaciones"></div>
                <button class="btn-main" style="background:#444; margin-top:12px;" onclick="toggleMap()">üó∫Ô∏è Ver Mapa Interactivo</button>
                <div id="map-container"><div id="map"></div></div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 10px 0; font-size:1.1rem; font-family:'Montserrat'">‚≠ê Mis Rutas Favoritas</h2>
            
            <div class="search-box">
                <input type="text" id="input-busqueda" placeholder="Buscar lugar real (Ej: Camp Nou)..." oninput="buscarLugares(this.value)">
                <div id="sugerencias" class="suggestions"></div>
            </div>

            <button id="btn-add-fav" class="btn-main" style="background:var(--accent-yellow, #ffcc00); color:black; margin-top:10px; display:none;" onclick="guardarLugarSeleccionado()">A√±adir a Favoritos</button>

            <div class="fav-list" id="lista-favoritos">
                </div>
        </div>
    </div>

    <div id="sobremi" class="section">
        <div class="card" style="line-height:1.6">
            <h2 style="color:var(--bicing-red); font-family:'Montserrat'">Acerca de</h2>
            <p><strong>BCN Mobility PRO</strong> ha sido desarrollada por <strong>√Ångel</strong>, un joven de 24 a√±os de Barcelona, apasionado por las nuevas tecnolog√≠as y la optimizaci√≥n de la vida urbana.</p>
            <p>Esta herramienta utiliza datos en tiempo real para ofrecer la mejor experiencia de movilidad en la ciudad condal.</p>
            <hr style="opacity:0.1">
            <p style="font-size:0.9rem; color:#888;">¬© 2024 √Ångel Dev - Barcelona Tech.</p>
        </div>
    </div>

    <div class="spotify-player">
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:35px; height:35px; border-radius:50%; background:linear-gradient(45deg, #e30613, #00a1df);"></div>
            <div style="font-size:0.75rem;"><b>Lo-Fi BCN</b><br><span style="opacity:0.6">Urban Mix</span></div>
        </div>
        <button onclick="toggleMusic()" id="btn-play" style="background:white; border:none; width:30px; height:30px; border-radius:50%;">‚ñ∂</button>
    </div>

    <audio id="music-track" loop src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"></audio>
    <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        let map = null;
        let darkMode = false;
        let audioIniciado = false;
        let lugarTemporal = null;

        // Cargar favoritos o defaults
        const defaultFavs = [
            { nombre: "Mercabarna", lat: 41.334, lon: 2.119 },
            { nombre: "Fira Barcelona", lat: 41.354, lon: 2.127 }
        ];
        let favoritos = JSON.parse(localStorage.getItem('bcn_favs_angel')) || defaultFavs;

        const bikeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',
            iconSize: [35, 35], iconAnchor: [17, 35], popupAnchor: [0, -35]
        });

        function feedback(v = 15) { if(navigator.vibrate) navigator.vibrate(v); }
        function iniciarAudioInit() { if(!audioIniciado) { toggleMusic(); audioIniciado = true; } }

        function showTab(id, el) {
            feedback(10);
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            document.getElementById('theme-btn').innerHTML = darkMode ? '‚òÄÔ∏è' : 'üåô';
            feedback(20);
        }

        // --- BUSCADOR REAL (Photon API - OpenStreetMap) ---
        async function buscarLugares(query) {
            const sug = document.getElementById('sugerencias');
            if (query.length < 3) { sug.style.display = 'none'; return; }
            
            try {
                const res = await fetch(`https://photon.komoot.io/api/?q=${query}&lat=41.38&lon=2.17&limit=5`);
                const data = await res.json();
                
                sug.innerHTML = data.features.map(f => `
                    <div class="suggestion-item" onclick="seleccionarLugar('${f.properties.name}', ${f.geometry.coordinates[1]}, ${f.geometry.coordinates[0]})">
                        <b>${f.properties.name}</b><br><small>${f.properties.city || ''} ${f.properties.street || ''}</small>
                    </div>
                `).join('');
                sug.style.display = 'block';
            } catch(e) {}
        }

        function seleccionarLugar(name, lat, lon) {
            lugarTemporal = { nombre: name, lat, lon };
            document.getElementById('input-busqueda').value = name;
            document.getElementById('sugerencias').style.display = 'none';
            document.getElementById('btn-add-fav').style.display = 'block';
        }

        function guardarLugarSeleccionado() {
            const btn = document.getElementById('btn-add-fav');
            favoritos.push(lugarTemporal);
            localStorage.setItem('bcn_favs_angel', JSON.stringify(favoritos));
            btn.style.background = "#28a745"; btn.innerHTML = "‚úì ¬°A√±adido!";
            feedback([30, 50, 30]);
            setTimeout(() => {
                btn.style.display = 'none'; btn.style.background = "#ffcc00"; btn.innerHTML = "A√±adir a Favoritos";
                renderFavoritos();
            }, 1000);
        }

        function eliminarFav(index) {
            feedback(40);
            favoritos.splice(index, 1);
            localStorage.setItem('bcn_favs_angel', JSON.stringify(favoritos));
            renderFavoritos();
        }

        function renderFavoritos() {
            const container = document.getElementById('lista-favoritos');
            container.innerHTML = favoritos.map((f, i) => `
                <div class="fav-card">
                    <div class="fav-header">
                        <div style="font-weight:800;">üìç ${f.nombre}</div>
                        <button onclick="eliminarFav(${i})" style="border:none; background:none; color:var(--bicing-red); font-weight:bold; cursor:pointer;">Eliminar</button>
                    </div>
                    <div class="transport-modes">
                        <button class="mode-btn" onclick="abrirRuta(${f.lat}, ${f.lon}, 'bicycling')">üö≤</button>
                        <button class="mode-btn" onclick="abrirRuta(${f.lat}, ${f.lon}, 'transit')">üöá</button>
                        <button class="mode-btn" onclick="abrirRuta(${f.lat}, ${f.lon}, 'driving')">üöó</button>
                    </div>
                </div>
            `).join('');
        }

        function abrirRuta(lat, lon, mode) {
            feedback(20);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=${mode}`, '_blank');
        }

        // --- BICING PRO (AZUL/ROJO) ---
        async function buscarBicing() {
            feedback(20);
            const btn = document.getElementById('btn-buscar');
            btn.innerHTML = "Actualizando...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                const res = await fetch('https://api.citybik.es/v2/networks/bicing');
                const data = await res.json();
                
                const stations = data.network.stations.map(s => ({
                    ...s, dist: Math.hypot(s.latitude-lat, s.longitude-lon)
                })).sort((a,b) => a.dist - b.dist).slice(0, 5);

                renderEstaciones(stations);
                initMap(lat, lon, stations);
                btn.innerHTML = "üîÑ Actualizar Bicing";
            });
        }

        function renderEstaciones(stations) {
            document.getElementById('resultados-bicing').style.display = 'block';
            document.getElementById('lista-estaciones').innerHTML = stations.map(s => {
                const e = s.extra?.ebikes || 0;
                const m = Math.max(0, s.free_bikes - e);
                return `
                    <div class="station-card">
                        <div style="flex:1">
                            <div style="font-weight:800;">${s.name.replace(/^\d+\s*-\s*/, '')}</div>
                            <div style="margin-top:8px; display:flex; gap:5px;">
                                <span class="badge badge-elec">‚ö° ${e}</span>
                                <span class="badge badge-mech">‚öôÔ∏è ${m}</span>
                            </div>
                        </div>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}&travelmode=walking" target="_blank" style="font-size:1.4rem; text-decoration:none;">üö∂</a>
                    </div>`;
            }).join('');
        }

        function initMap(lat, lon, stations) {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);
            L.tileLayer(darkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            L.circleMarker([lat, lon], { color: '#007bff', radius: 6 }).addTo(map);

            stations.forEach(s => {
                const e = s.extra?.ebikes || 0;
                const m = Math.max(0, s.free_bikes - e);
                L.marker([s.latitude, s.longitude], { icon: bikeIcon })
                 .addTo(map)
                 .bindPopup(`
                    <div style="text-align:center">
                        <b>${s.name}</b><br>
                        <span style="color:var(--bicing-blue); font-weight:bold;">‚ö° El√©ctricas: ${e}</span><br>
                        <span style="color:var(--bicing-red); font-weight:bold;">‚öôÔ∏è Mec√°nicas: ${m}</span>
                    </div>
                `);
            });
        }

        function toggleMap() { feedback(10); document.getElementById('map-container').classList.toggle('open'); setTimeout(() => map.invalidateSize(), 400); }

        function toggleMusic() {
            const track = document.getElementById('music-track');
            const btn = document.getElementById('btn-play');
            if (track.paused) { track.play(); btn.innerHTML = "‚è∏"; } 
            else { track.pause(); btn.innerHTML = "‚ñ∂"; }
            feedback(15);
        }

        renderFavoritos();
    </script>
</body>
</html>
