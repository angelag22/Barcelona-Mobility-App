<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCN Pro Mobility</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #212121; 
            --accent: #e30613; /* Rojo Smou/Bicing */
            --bg-color: #f2f4f8;
            --card-bg: #ffffff;
            --shadow: 0 8px 20px rgba(0,0,0,0.06);
            --radius: 20px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            padding: 20px; 
            color: var(--primary); 
            padding-bottom: 80px; /* Espacio para el reproductor */
        }
        
        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        h1 { 
            font-family: 'Montserrat', sans-serif; 
            font-size: 1.5rem; 
            margin: 0; 
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .status-badge {
            font-size: 0.75rem;
            background: #e0e0e0;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            color: #555;
        }

        /* WIDGETS (Los nuevos botones guapos) */
        .widget-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .card-widget { 
            background: var(--card-bg); 
            border-radius: var(--radius); 
            padding: 20px; 
            box-shadow: var(--shadow);
            transition: transform 0.1s ease;
            position: relative;
            overflow: hidden;
        }

        .card-widget:active {
            transform: scale(0.98); /* Efecto de pulsaci√≥n */
        }

        .widget-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .icon-box {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .title-box h3 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .title-box p { margin: 0; font-size: 0.85rem; color: #888; }

        /* Estilos espec√≠ficos por tipo */
        .bicing-widget .icon-box { background: #ffebee; color: #d32f2f; }
        .metro-widget .icon-box { background: #e3f2fd; color: #1976d2; }
        .bus-widget .icon-box { background: #fff3e0; color: #f57c00; }
        .map-widget .icon-box { background: #e8f5e9; color: #388e3c; }

        /* Bot√≥n de acci√≥n grande */
        .big-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* RESULTADOS BICING */
        #resultados-bicing { display: none; margin-top: 15px; animation: fadeIn 0.3s ease; }
        
        .station-item {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .badges { display: flex; gap: 5px; margin-top: 5px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .elec { background: #ffcdd2; color: #b71c1c; }
        .mech { background: #cfd8dc; color: #455a64; }

        /* MAPA PEQUE√ëO */
        #map-container {
            height: 200px; /* Altura fija peque√±a */
            width: 100%;
            border-radius: 15px;
            margin-top: 15px;
            display: none; /* Oculto por defecto */
            border: 2px solid #ddd;
        }
        #map { width: 100%; height: 100%; border-radius: 13px; }

        /* REPRODUCTOR FLOTANTE */
        .music-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            width: 90%;
            max-width: 350px;
        }

        .play-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .track-info { font-size: 0.85rem; font-weight: bold; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header>
        <h1>BCN Movilidad</h1>
        <div class="status-badge">PRO v2.0</div>
    </header>

    <div class="widget-grid">
        
        <div class="card-widget bicing-widget">
            <div class="widget-header">
                <div class="icon-box">üö≤</div>
                <div class="title-box">
                    <h3>Bicing Live</h3>
                    <p>Encuentra bicis a tu alrededor</p>
                </div>
            </div>
            
            <button class="big-btn" id="btn-buscar" onclick="buscarBicing()">
                <span>üîç Buscar Ahora</span>
            </button>

            <div id="resultados-bicing">
                <div id="lista-estaciones"></div>
                
                <button onclick="toggleMap()" class="big-btn" style="background: #fff; color: #333; border: 2px solid #eee; margin-top:10px;">
                    üó∫Ô∏è Ver/Ocultar Mapa
                </button>
                
                <div id="map-container"><div id="map"></div></div>
            </div>
        </div>

        <div class="card-widget metro-widget" onclick="ir('Mercabarna', 'transit')">
            <div class="widget-header">
                <div class="icon-box">üçé</div>
                <div class="title-box">
                    <h3>Mercabarna</h3>
                    <p>Pulsa para ruta en Metro/Bus</p>
                </div>
                <div style="margin-left:auto; opacity:0.3">‚ûî</div>
            </div>
        </div>

        <div class="card-widget bus-widget" onclick="ir('Fira Gran Via', 'transit')">
            <div class="widget-header">
                <div class="icon-box">üè¢</div>
                <div class="title-box">
                    <h3>Europa | Fira</h3>
                    <p>Pulsa para ruta en FGC</p>
                </div>
                <div style="margin-left:auto; opacity:0.3">‚ûî</div>
            </div>
        </div>

        <div class="card-widget map-widget">
            <div class="widget-header">
                <div class="icon-box">üìç</div>
                <div class="title-box">
                    <h3>¬øA d√≥nde vas?</h3>
                    <input type="text" id="destino-input" placeholder="Ej: Sagrada Familia" 
                           style="width: 100%; border:none; border-bottom: 2px solid #eee; padding: 5px; margin-top: 5px; font-size: 1rem; outline: none;">
                </div>
            </div>
            <button class="big-btn" onclick="irLibre()" style="background: #4caf50;">Ir ahora</button>
        </div>

    </div>

    <div class="music-player">
        <button class="play-btn" onclick="toggleMusic()" id="btn-play">‚ñ∂</button>
        <div class="track-info">üéµ City Lo-Fi Beats</div>
        <audio id="audio-player" loop>
            <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
        </audio>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        let map = null;
        
        // --- 1. FUNCI√ìN DE VIBRACI√ìN (HAPTICS) ---
        function vibrar() {
            // Vibra 15ms (muy corto y elegante)
            if (navigator.vibrate) navigator.vibrate(15);
        }

        // --- 2. RUTAS GOOGLE MAPS (NATIVO) ---
        function ir(destino, modo) {
            vibrar();
            // Esto abre la APP de Google Maps directamente
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destino + " Barcelona")}&travelmode=${modo}`;
            window.open(url, '_blank');
        }

        function irLibre() {
            const dest = document.getElementById('destino-input').value;
            if(dest) ir(dest, 'transit');
        }

        // --- 3. L√ìGICA BICING ---
        async function buscarBicing() {
            vibrar();
            const btn = document.getElementById('btn-buscar');
            const resultados = document.getElementById('resultados-bicing');
            const lista = document.getElementById('lista-estaciones');
            
            btn.innerHTML = '<span class="loader"></span> Buscando...';
            
            if (!navigator.geolocation) {
                alert("Necesitas GPS");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                try {
                    const res = await fetch('https://api.citybik.es/v2/networks/bicing');
                    const data = await res.json();
                    
                    // L√≥gica de distancias
                    let stations = data.network.stations.map(s => ({
                        ...s,
                        dist: calcDist(lat, lon, s.latitude, s.longitude)
                    })).sort((a,b) => a.dist - b.dist).slice(0, 5); // Top 5

                    // Renderizar lista bonita
                    lista.innerHTML = "";
                    stations.forEach(s => {
                        const ebikes = s.extra?.ebikes || 0;
                        const mech = s.free_bikes - ebikes;
                        
                        const html = `
                            <div class="station-item" onclick="vibrar()">
                                <div>
                                    <div style="font-weight:700">${s.name}</div>
                                    <div class="badges">
                                        <span class="badge elec">‚ö° ${ebikes}</span>
                                        <span class="badge mech">‚öôÔ∏è ${mech}</span>
                                    </div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-size:0.8rem; color:#888">${Math.round(s.dist*1000)}m</div>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}&travelmode=walking" 
                                       target="_blank" style="text-decoration:none; font-size:1.2rem;">üö∂</a>
                                </div>
                            </div>
                        `;
                        lista.innerHTML += html;
                    });

                    resultados.style.display = 'block';
                    btn.innerHTML = 'üîÑ Actualizar';
                    
                    // Preparamos el mapa (pero no lo mostramos a√∫n)
                    initMap(lat, lon, stations);

                } catch (e) {
                    btn.innerHTML = '‚ùå Error API';
                }
            });
        }

        // --- 4. MAPA PEQUE√ëO Y CONTROLABLE ---
        function toggleMap() {
            vibrar();
            const container = document.getElementById('map-container');
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                setTimeout(() => { if(map) map.invalidateSize(); }, 100);
            } else {
                container.style.display = 'none';
            }
        }

        function initMap(lat, lon, stations) {
            if(map) map.remove();
            map = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: ''
            }).addTo(map);

            // Marcador usuario
            L.circleMarker([lat, lon], { color: '#2196F3', radius: 8 }).addTo(map).bindPopup("T√∫");

            // Marcadores estaciones
            stations.forEach(s => {
                L.circleMarker([s.latitude, s.longitude], { color: '#e30613', radius: 6 }).addTo(map);
            });
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- 5. REPRODUCTOR DE M√öSICA ---
        function toggleMusic() {
            vibrar();
            const audio = document.getElementById('audio-player');
            const btn = document.getElementById('btn-play');
            
            if (audio.paused) {
                audio.play();
                btn.innerHTML = "‚è∏";
                btn.style.background = "#e30613"; // Rojo al sonar
            } else {
                audio.pause();
                btn.innerHTML = "‚ñ∂";
                btn.style.background = "#212121"; // Negro pausado
            }
        }
    </script>
</body>
</html>
