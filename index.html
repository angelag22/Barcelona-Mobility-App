<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCN Mobility PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bicing-red: #e30613; 
            --bicing-blue: #00a1df; 
            /* Modo D√≠a */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #121212;
            --btn-sec: #eeeeee;
        }

        /* Variables Modo Noche */
        body.dark-mode {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --btn-sec: #333333;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 100px; color: var(--text); transition: 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        .card { 
            background: var(--card); border-radius: 24px; padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 15px; 
            transition: 0.3s;
        }

        .btn-main {
            background: var(--bicing-red); color: white; border: none; width: 100%; padding: 18px;
            border-radius: 18px; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 8px 20px rgba(227, 6, 19, 0.2); transition: 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-main:active { transform: scale(0.95); }

        .btn-sec {
            background: var(--btn-sec); color: var(--text); border: none; padding: 12px;
            border-radius: 14px; font-weight: 700; width: 100%; margin-top: 10px; cursor: pointer;
        }

        /* MAPA PLEGABLE */
        #map-container { 
            height: 0; /* Empieza plegado */
            width: 100%; border-radius: 20px; margin-top: 0; 
            overflow: hidden; border: 0px solid #ddd; 
            transition: height 0.4s ease-out, margin-top 0.4s;
        }
        #map-container.open { height: 300px; margin-top: 15px; border: 1px solid #ddd; }
        #map { width: 100%; height: 100%; }

        /* LISTA ESTACIONES */
        .station-card {
            background: var(--card); border: 1px solid rgba(128,128,128,0.1); border-radius: 16px;
            padding: 14px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .badge { padding: 6px 12px; border-radius: 10px; font-size: 0.85rem; font-weight: 800; color: white; }
        .badge-elec { background: var(--bicing-blue); }
        .badge-mech { background: var(--bicing-red); }

        /* PLAYER SPOTIFY STYLE */
        .spotify-player {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 400px; background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 12px 20px; border-radius: 20px; display: flex; align-items: center;
            justify-content: space-between; z-index: 9999; border: 1px solid rgba(255,255,255,0.1); color: white;
        }
        .play-btn { background: white; border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }

        .theme-toggle { background: var(--card); border: none; padding: 10px; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.2rem; }

        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rot 1s linear infinite; }
        @keyframes rot { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body onclick="iniciarAudioInit()">

    <header>
        <h1 style="font-family:'Montserrat'; margin:0; font-size:1.4rem;">BCN Mobility <span style="color:var(--bicing-red)">PRO</span></h1>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
    </header>

    <div class="card">
        <h2 style="margin:0 0 15px 0; font-family:'Montserrat'; font-size:1.1rem;">üö≤ Bicing Live</h2>
        <button id="btn-buscar" class="btn-main" onclick="buscarBicing()">üîç Buscar Estaciones</button>

        <div id="resultados-bicing" style="display:none;">
            <div id="lista-estaciones"></div>
            <button id="btn-map-toggle" class="btn-sec" onclick="toggleMap()">üó∫Ô∏è Mostrar Mapa</button>
            <div id="map-container"><div id="map"></div></div>
        </div>
    </div>

    <div class="card">
        <h2 style="margin:0 0 15px 0; font-size:0.8rem; color:#888; text-transform:uppercase;">Destinos</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn-sec" style="background:#e30613; color:white;" onclick="ir('Mercabarna', 'transit')">üçé Mercabarna</button>
            <button class="btn-sec" style="background:#ff8c00; color:white;" onclick="ir('Europa Fira', 'transit')">üè¢ Fira</button>
        </div>
    </div>

    <div class="spotify-player">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="width:40px; height:40px; border-radius:6px; background:linear-gradient(45deg, #e30613, #00a1df);"></div>
            <div style="font-size:0.8rem;">
                <div style="font-weight:800;">Movilidad Urbana</div>
                <div style="opacity:0.6;">Lo-Fi Mix</div>
            </div>
        </div>
        <button class="play-btn" onclick="toggleMusic()" id="btn-play-global">‚ñ∂</button>
    </div>

    <audio id="music-track" loop src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"></audio>
    <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        let map = null;
        let audioIniciado = false;
        let darkMode = false;

        const bicingIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3721/3721619.png',
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
        });

        function feedback() {
            if (navigator.vibrate) navigator.vibrate(15);
            const snd = document.getElementById('click-sound');
            snd.currentTime = 0; snd.volume = 0.3; snd.play();
        }

        function iniciarAudioInit() { if (!audioIniciado) { toggleMusic(); audioIniciado = true; } }

        // --- MODO D√çA/NOCHE ---
        function toggleTheme() {
            feedback();
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            document.getElementById('theme-btn').innerHTML = darkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Si el mapa ya existe, actualizamos sus colores
            if (map) {
                const layerUrl = darkMode 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                    : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
                
                L.tileLayer(layerUrl).addTo(map);
            }
        }

        // --- PLEGADO/DESPLEGADO DE MAPA ---
        function toggleMap() {
            feedback();
            const container = document.getElementById('map-container');
            const btn = document.getElementById('btn-map-toggle');
            
            if (container.classList.contains('open')) {
                container.classList.remove('open');
                btn.innerHTML = "üó∫Ô∏è Mostrar Mapa";
            } else {
                container.classList.add('open');
                btn.innerHTML = "üîº Ocultar Mapa";
                // Leaflet necesita recalcular tama√±o cuando se abre
                setTimeout(() => { if(map) map.invalidateSize(); }, 400);
            }
        }

        function ir(dest, modo) {
            feedback();
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest + " Barcelona")}&travelmode=${modo}`, '_blank');
        }

        async function buscarBicing() {
            feedback();
            const btn = document.getElementById('btn-buscar');
            btn.innerHTML = '<span class="loader"></span> Buscando...';

            try {
                const apiPromise = fetch('https://api.citybik.es/v2/networks/bicing');
                const gpsPromise = new Promise((res, rej) => {
                    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: false, timeout: 5000 });
                });

                const [res, pos] = await Promise.all([apiPromise, gpsPromise]);
                const data = await res.json();
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                const stations = data.network.stations.map(s => ({
                    ...s, dist: calcDist(lat, lon, s.latitude, s.longitude)
                })).sort((a,b) => a.dist - b.dist).slice(0, 5);

                renderEstaciones(stations);
                initMap(lat, lon, stations);
                btn.innerHTML = 'üîÑ Actualizar';

            } catch (err) { btn.innerHTML = 'üîç Reintentar'; }
        }

        function renderEstaciones(stations) {
            const container = document.getElementById('lista-estaciones');
            container.innerHTML = stations.map(s => {
                const e = s.extra?.ebikes || 0;
                const m = s.free_bikes - e;
                return `
                    <div class="station-card" onclick="feedback()">
                        <div>
                            <div style="font-weight:800; font-size:0.95rem;">${s.name}</div>
                            <div style="display:flex; gap:8px; margin-top:6px;">
                                <span class="badge badge-elec">‚ö° ${e}</span>
                                <span class="badge badge-mech">‚öôÔ∏è ${m}</span>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="color:#888; font-size:0.8rem; font-weight:700;">${Math.round(s.dist*1000)}m</div>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}&travelmode=walking" 
                               target="_blank" style="text-decoration:none; font-size:1.5rem;" onclick="feedback()">üö∂</a>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('resultados-bicing').style.display = 'block';
        }

        function initMap(lat, lon, stations) {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);
            
            const layerUrl = darkMode 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
            
            L.tileLayer(layerUrl).addTo(map);
            L.circleMarker([lat, lon], { color: '#007bff', radius: 6, fillOpacity: 1 }).addTo(map);

            stations.forEach(s => {
                const eb = s.extra?.ebikes || 0;
                const mb = s.free_bikes - eb;
                L.marker([s.latitude, s.longitude], { icon: bicingIcon })
                 .addTo(map)
                 .bindPopup(`<b>${s.name}</b><br>‚ö° ${eb} | ‚öôÔ∏è ${mb}`);
            });
        }

        function toggleMusic() {
            const track = document.getElementById('music-track');
            const btn = document.getElementById('btn-play-global');
            if (track.paused) { track.play(); btn.innerHTML = "‚è∏"; } 
            else { track.pause(); btn.innerHTML = "‚ñ∂"; }
            feedback();
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
